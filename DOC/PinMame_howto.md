# PinMame Howto

## Getting started

For using Lisy you need an additional Raspberry Pi. At the moment all zero and model 3 type Pi's are supported.  
Download the [Lisy software](https://lisy.dev/software.html) and install it to the SD card of your Raspberry Pi. 
In order to run the code for your game, you need the PinMame game numer of your game which can be found [here](https://github.com/AmokSolderer/APC/blob/V00.31/DOC/lisyminigames.csv).

### APC 3 with Raspberry Pi on board

Plug the Pi into connector J1 on the APC. Then power up your APC, enter the 'System Settings' and select 'Remote Control' as 'Active Game' and 'On Board' as 'Connect Type'.  
Now enter the 'Game Settings' and set 'PinMame Game' to the number of your game. 

As the synchronization of Lisy and the APC is not yet finalized it may now necessary to power-cycle your game.  
During booting the display should show 'Booting Lisy'. After the booting has finished the yellow LED on the APC will be turned on, followed by the green one when the connection to the APC has been established. Now the name of the game should appear in the displays with a countdown after which the game emulation starts.

### Using the Lisy_Mini board

Power up your APC, enter the 'System Settings' and select 'Remote Control' as 'Active Game' and 'USB' as 'Connect Type'. Set the S2 DIP switches on the Lisy_Mini board to your game number. 

Connect the power connector K8 of your Lisy_Mini board to the 5V supply of your pinball machine. (You can also supply Lisy_Mini by the micro USB port of the Pi. In this case you need a 2A capable power supply and you should power up Lisy after the APC and connect the USB cable then.)

Start your pinball with Lisy_Mini and the APC. The displays of your pinball machines should show 'USB control' until the connection between Lisy and the APC has been established. 

## Using an original audio board

System 3 - 7 machines can be used with an old audio board. For System 7 an [additional cable](https://github.com/AmokSolderer/APC/blob/V00.31/DOC/HowToStart.md#system-7-audio-cable) is required to connect the audio board. The System 3 - 6 games control the audio boards via the solenoid drivers.

For the APC to control the external audio board you have to enter the [game settings](https://github.com/AmokSolderer/APC/blob/V00.31/DOC/Settings.md#game-settings-in-remote-control-mode) while in Remote Control Mode and set setting 2 (PinMame Sound) from 0 (APC) to 1 (Board).

## Let the APC board do the sound

The following is only necessary if you don't use the old audio board. Reasons for this can be that you want to use a System 9 - 11 machine, you don't have a suitable board, you want to change some sounds or you want to add an additional music track to your System 3 - 7 game.

For the APC to play them, all sounds have to be present on the SD card. In the following sections you'll learn how to do that.

### Recording the sounds

If you want to get the original sounds for your machine, you have to install PinMame for Windows as the Unix version has severe sound issues.

After PinMame is running press F4 to enter the 'Sound Command Mode' and enter the prefix and the hexadecimal sound number of the sound you want to record. Then press F5 to start the recording, SPACE to play the sound and F5 again to stop recording. The sound can be found in PinMame's 'wave' folder.  
For some reason the PinMame sounds have a sampling rate of 48KHz and must therefore be converted to the normal sampling rate of 44.1KHz. You can use a free audio editor like Audacity to adjust the start and end time of your sound sample as well as the sampling rate.  
Sometimes the volume of the sound and music files generated by PinMame differs quite a lot. However, the APC offers no correction setting to match the volume levels of those channels, which means you should also use Audacity to adjust those levels accordingly.  
Mokopin (from the Flippertreff forum) has written some [Instructions for extracting sound files](https://github.com/AmokSolderer/APC/blob/V00.31/DOC/PinMameSounds.md) which explains the automatic extraction of sound files and the use of Audacity in more detail.

Like all sounds to be played by the APC the WAV files have to be processed with my Audio Data Converter. You can find additional information about this tool in the [Useful Software Tools](https://github.com/AmokSolderer/APC/blob/V00.31/DOC/UsefulSWtools.md) page.

In order for the APC to find the right sound, all sounds have to be named with the prefix (only one digit), underscore, the hexadecimal number of the sound and .snd as the extension. For example, the name of sound 0xf1 of prefix 00 would be 0_f1.snd. All files need to be placed in the root folder of APC's SD card.

System 7 sound commands have 5 bit and can therefore only select 32 (0x20 in hex) different sounds. For some reason PinMame seems to add 32 to each sound number. Hence, the filenames of the system 7 sounds must be numbered from 0x21 to 0x40 for the APC to find the correct file.  
This offset might be different for other system generations.

### Which sounds are required?

When you start from scratch you should play your game with Lisy being in Debug Mode. Please read the [Controlling Lisy page](https://github.com/AmokSolderer/APC/blob/V00.31/DOC/LisyDebug.md) to learn how to do this.

When you're done playing, press the shutdown switch SW1 on your APC board to make it exit the emulation and store the log file to the SD card. The file will be located on the Pi's SD card in the folder lisy/lisy_m/debug.

In lisy_m_debug.txt playing a sound looks like

    [461.372965][0.000064] LISY_W sound_handler: board:0 0x79 (121)
    [461.372985][0.000020] play soundindex 121 on board 0 
    [461.373005][0.000020] USB_write(3 bytes): 0x32 0x01 0x79

In this case sound 0x79 of prefix (board) 0 shall be played which means you have to record the sound command 0079 in PinMame, convert it and write it to the APC's SD card as 0_79.snd.

### Finding out which sounds are still missing

After you have extracted most of the files, there'll be the point when only a few files are still missing and you need to find out their numbers. Of course you could still scan the Lisy log for unknown sound numbers, but in this stage it might be easier to use the 'Audio Debug Mode' of the APC.  
You can activate this mode in the game settings. To do this you have to press Advance for more than a second to enter the settings. Use Advance to change from system to game settings and press the start button to enter those. Use Advance to proceed to the 'Debug Mode' setting, then change it to 'AUDIO' by pressing the start button. Go to 'Exit Settings' by pressing Advance and the Start button to confirm.

In Audio Debug mode the lower display(s) are used for audio information. The Player 3 display (or the left part of the lower display for BK2K type displays) shows information for sound prefix 00 and the Player 4 display (right part of lower display for BK2K) does the same for prefix 01. If the requested sound is found on the SD card, it's hex number is shown in the left side of the corresponding display and the sound is played normally. If the sound file is missing it's hex number is shown on the right side of the corresponding display which makes it easy to find missing sound files.  
As the pre System11 displays cannot show letters, the corresponding sound numbers are shown in decimal values when this kind of display is selected.

### Sound problems

Most sound problems like lags and stuttering are caused by the performance of the SD card. Take a look at the [If things don't work](https://github.com/AmokSolderer/APC/blob/V00.31/DOC/Problems.md) section for more.

### Unknown Command errors

If you're using the APC with Lisy/PinMame and the 'Unknown Command' error message followed by a number pops up on your lower displays then you have a problem with your serial communication. This is a severe problem which needs to be fixed. You can learn how to do this in the [If things don't work](https://github.com/AmokSolderer/APC/blob/V00.31/DOC/Problems.md) section.

## Programming exceptions

The APC features a machine specific exception handling, which means that you can manipulate your game even though it is running in PinMame. To enable this for your machine you have to add a game specific section to the PinMameExceptions.ino file and recompile the SW.
You can manipulate sound, lamp, switch, display and solenoid commands. Some of these expections are necessary to make your machine work correctly while others are simply improvements or moderate rule changes.

### Doing sound exceptions for the Jungle Lord

Let's use the System 7 Jungle Lord as an example how to use exception handling in pratice:

First of all we need to generate a Jungle Lord specific code section to handle all the required exceptions. There's a template named

    byte EX_Blank(byte Type, byte Command)

in PinMameExceptions.ino you could use as a start. So let's create a copy of this and rename it to

    byte EX_JungleLord(byte Type, byte Command)

In order for the system to use this code section, we have to add it to EX_Init which is at the ende of PinMameExceptions.ino and determines which code is used for which machine. At the time this documant was created, Jungle Lord was the first machine to have such an exception handling, so there's just one entry in EX_Init yet:

    void EX_Init(byte GameNumber) {
      switch(GameNumber) {
      case 20:                                            // Jungle Lord
        EX_EjectSolenoid = 2;                             // specify eject coil for improved ball release
        USB_SolTimes[20] = 0;                             // allow permanent on state for magna save relais
        USB_SolTimes[21] = 0;
        PinMameException = EX_JungleLord;                 // use exception rules for Jungle Lord
        break;
      default:
        PinMameException = EX_DummyProcess;}}

All other games do not have an exception handler yet, so the exception pointer just points to a dummy process which only plays the standard sounds, but knows no exceptions.
The change of the USB_SolTimes is only necessary because in this example I also want to improve the reaction time of the magna save magnets and for this it must be allowed to turn on the magnets permanently. But ignore this for now as well as the EX_EjectSolenoid.

Jungle Lord uses certain [System 7 specific sound commands](https://github.com/AmokSolderer/APC/blob/V00.31/DOC/PinMame.md#system-7) the APC has to know for the sound to work correctly. As System7 just uses one sound channel, these exceptions have to be put into the SoundCommandCh1 case of our EX_JungleLord program. For a System11 game you'd also have to prepare exceptions for SoundCommandCh2 as these games use both sound channels.

The first exception is the 0x26 sound command which triggers one of four random spoken phrases. In the exception handler this looks like this:

    case SoundCommandCh1:                               // sound commands for channel 1
      if (Command == 38){                               // sound command 0x26 - start game
        char FileName[13] = "0_26_000.snd";             // generate base filename
        FileName[7] = 48 + random(4) + 1;               // change the counter according to random number
        PlaySound(52, (char*) FileName);}               // play the corresponding sound file

The APC expects the corresponding sound files to be named 0_26_00X.snd with the X being one for the first file, two for the second and so on.
First we generate the base filename "0_26_000.snd", then we change the 8th character of this string to a random number between 1 and 4 and play the sound file with a priority of 52.

The next special sound command of the Jungle Lord is 0x2d. This is a looping sound series, which means it starts again with the first tune after the last has been played. The corresponding code is:

    else if (Command == 45){                          // sound command 0x2d - multiball start - sound series
      if (SoundSeries[1] < 31)                        // this sound has 31 tunes
        SoundSeries[1]++;                             // every call of this sound proceeds with next tune
      else
        SoundSeries[1] = 1;                           // start all over again
      char FileName[13] = "0_2d_000.snd";             // generate base filename
      FileName[7] = 48 + (SoundSeries[1] % 10);       // change the 7th character of filename according to current tune
      FileName[6] = 48 + (SoundSeries[1] % 100) / 10; // the same with the 6th character
      PlaySound(51, (char*) FileName);}               // play the sound

For this we need an additional variable SoundSeries which stores the number of the tune currently being played. This variable has to be defined as static byte at the beginning of our EX_JungleLord.
At first it is checked whether the last tune of this series is currently being played. If yes then the tune number is set back to one otherwise it is increased by one. After that the base filename is generated, the new tune number is written into it and the sound is played.

Sound command 0x2a is also a sound series, so it's treated very similarly.

    else if (Command == 42){                          // sound command 0x2a - background sound - sound series
      SoundSeries[1] = 0;                             // reset the multiball start sound
      if (SoundSeries[0] < 29)                        // BG sound has 29 tunes
        SoundSeries[0]++;                             // every call of this sound proceeds with the next tune
      char FileName[13] = "0_2a_000.snd";             // generate base filename
      FileName[7] = 48 + (SoundSeries[0] % 10);       // change the 7th character of filename according to current tune
      FileName[6] = 48 + (SoundSeries[0] % 100) / 10; // the same with the 6th character
      for (byte i=0; i<12; i++) {                     // store the name of this sound
        USB_RepeatSound[i] = FileName[i];}
      QueueNextSound(USB_RepeatSound);                // select this sound to be repeated
      PlaySound(51, (char*) FileName);}               // play the sound

One difference is that this sound series is not a looping one which means the tune counter is not reset to one, but stays at the highest value until it is reset by the stop sound command 0x2c. Furthermore this command resets the tune of the 0x2d sound series (SoundSeries[1] = 0;).
However, the major difference is that 0x2a is the background sound which can be interrupted by other sounds, but will continue afterwards.
In the APC SW the Aftersound pointer can be used for this. This pointer can be set to a routine which is called automatically when a sound has run out. Here we call QueueNextSound which takes the filename USB_RepeatSound points to as an argument. It sets the AfterSound pointer to a routine which will play the filename stored in USB_RepeatSound when the current sound file is running out. Setting AfterSound = 0 will disable this mechanism.

Every System7 machine additionally needs the stop sound command 0x2c.

    else if (Command == 44) {                         // sound command 0x2c - stop sound
      AfterSound = 0;
      SoundSeries[0] = 0;                             // Reset BG sound
      SoundSeries[1] = 0;                             // reset the multiball start sound
      StopPlayingSound();}

This command sets AfterSound = 0 which will prevent the BG sound from being restarted. Then it resets both sound series and stops the current playback.

Up to now we have only implemented the sounds that are somehow special for the Jungle Lord, but the majority of the sounds are ordinary ones. That means we need a default handler for all the sound numbers that have not been covered by the exceptions above.

    else {                                            // standard sound
      char FileName[9] = "0_00.snd";                  // handle standard sound
      if (USB_GenerateFilename(1, Command, FileName)) { // create filename and check whether file is present
        PlaySound(51, (char*) FileName);}}
    return(0);                                        // return number not relevant for sounds

The filenames of these sounds just consist of the channel number, an underscore and the sound number in hex followed by ".snd". There is a routine called

    byte USB_GenerateFilename(byte Channel, byte Sound, char* FileName)

which adds the hex code to a given filename and handles the display messages if the audio debug mode is active. It returns a 1 in case the soundfiles does exist and a 0 if it doesn't. Is is therefore only necessary to play the sound when the return value has been 1.

The return marks the end of the SoundCommandCh1 case.

### Doing music exceptions for System11 machines

With System11 the audio boards became much more powerful. This made it possible to play an independent music score additional to the sound and speech effects.

Most of these music scores consist of an intro and a looping part which is repeated all over. If you want it easy, you could just put the intro and some repetitions of the looping part in one file. This will work in most cases, but if you wait long enough the music will just run out.
In order to prevent this from happening, the intro and the looping part must be in separate files and an exception rule must handle the sequencing.

Let's use music track 4 from Pinbot as an example. In the SoundCommandCh2 case the following code handles track4:

    else if (Command == 4) {                          // music track 4
      PlayMusic(50, "1_04.snd");                      // play non looping part of music track
      QueueNextMusic("1_04L.snd");}                   // queue looping part as next music to be played

When audio channel 2 receives command 4 then the intro 1_04.snd is played first and the QueueNextMusic command is used to queue the looping part 1_04L.snd to be played after the intro has run out. As long as the AfterMusic variable is not set to zero, the looping part will be repeated automatically.

# More PinMameExceptions

These were basic exceptions you have to provide for the APC to be able to use the audio files on your SD card correctly.
However, PinMameExceptions can do much more than that, so take a look at the [PinMameExceptions page](https://github.com/AmokSolderer/APC/blob/V00.31/DOC/PinMameExceptions.md) to learn more.
